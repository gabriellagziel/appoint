<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing & Invoices - App-Oint Enterprise</title>
    <style>
        :root {
            --color-primary: #0A84FF;
            --color-secondary: #5AC8FA;
            --color-accent: #64D2FF;
            --color-neutral-dark: #141414;
            --color-neutral-light: #E5E5EA;
            --font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
            --border-radius: 8px;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter, -apple-system, BlinkMacSystemFont, sans-serif';
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 50%, var(--color-accent) 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }

        .logo {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .nav-links {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .page-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 30px;
        }

        .billing-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .pricing-section {
            margin-bottom: 40px;
        }

        .pricing-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .pricing-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .pricing-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .pricing-card.featured {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
            position: relative;
        }

        .pricing-card.featured::before {
            content: "MOST POPULAR";
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: #3b82f6;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .pricing-card h4 {
            margin: 0 0 16px 0;
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .price {
            font-size: 32px;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 4px;
        }

        .price-subtitle {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 20px;
        }

        .pricing-features {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
        }

        .pricing-features li {
            padding: 8px 0;
            font-size: 14px;
            color: #374151;
        }

        .pricing-note {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }

        .pricing-note p {
            margin: 0;
            font-size: 14px;
            color: #0369a1;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .invoices-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 30px;
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .invoice-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .invoice-info {
            flex: 1;
        }

        .invoice-number {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .invoice-details {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .invoice-amount {
            font-size: 1.3rem;
            font-weight: 700;
            margin-right: 20px;
        }

        .invoice-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 15px;
        }

        .status-pending {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .status-paid {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }

        .status-overdue {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }

        .invoice-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-primary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .bank-transfer-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
        }

        .bank-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .bank-detail {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
        }

        .bank-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .bank-value {
            font-weight: 600;
            font-family: monospace;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.1rem;
            opacity: 0.8;
        }

        .error {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div>
                <div class="logo">App-Oint Enterprise</div>
                <div class="nav-links">
                    <a href="dashboard.html" class="nav-link">üìä Dashboard</a>
                    <a href="api-keys.html" class="nav-link">üîë API Keys</a>
                    <a href="analytics.html" class="nav-link">üìà Analytics</a>
                    <a href="locations.html" class="nav-link">üìç Locations</a>
                    <a href="integrations.html" class="nav-link">üîó Integrations</a>
                    <a href="white-label.html" class="nav-link">üé® White Label</a>
                    <a href="billing.html" class="nav-link">üßæ Billing</a>
                    <a href="settings.html" class="nav-link">‚öôÔ∏è Settings</a>
                </div>
            </div>
            <div class="user-info">
                <div class="user-avatar">E</div>
                <div>
                    <div>Enterprise Client</div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">billing@appoint.com</div>
                </div>
                <button onclick="logout()" class="action-btn btn-secondary">Logout</button>
            </div>
        </div>

        <h1 class="page-title">üßæ Billing & Invoices</h1>
        <p class="page-subtitle">Manage your invoices and payment information</p>

        <div class="billing-stats">
            <div class="stat-item">
                <div class="stat-value">‚Ç¨0.49</div>
                <div class="stat-label">Per Meeting (No Map)</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">‚Ç¨0.99</div>
                <div class="stat-label">Per Meeting (With Map)</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">$1,999</div>
                <div class="stat-label">Total Paid</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">12</div>
                <div class="stat-label">Total Invoices</div>
            </div>
        </div>

        <div class="pricing-section">
            <h3 class="section-title">üí∞ Pay-Per-Meeting Pricing</h3>
            <div class="pricing-cards">
                <div class="pricing-card">
                    <h4>Basic Meeting</h4>
                    <div class="price">‚Ç¨0.49</div>
                    <div class="price-subtitle">per meeting</div>
                    <ul class="pricing-features">
                        <li>‚úÖ Meeting creation via API</li>
                        <li>‚úÖ Calendar integration</li>
                        <li>‚úÖ Mobile app delivery</li>
                        <li>‚úÖ Reminder notifications</li>
                        <li>‚ùå No location/map</li>
                    </ul>
                </div>
                <div class="pricing-card featured">
                    <h4>Meeting with Map</h4>
                    <div class="price">‚Ç¨0.99</div>
                    <div class="price-subtitle">per meeting</div>
                    <ul class="pricing-features">
                        <li>‚úÖ Everything in Basic</li>
                        <li>‚úÖ Google Maps integration</li>
                        <li>‚úÖ Location selection</li>
                        <li>‚úÖ Directions & navigation</li>
                        <li>‚úÖ Business search</li>
                    </ul>
                </div>
            </div>
            <div class="pricing-note">
                <p><strong>No subscriptions, no hidden fees.</strong> Pay only for meetings your users actually create.
                    Monthly invoices sent via email with 7-10 day payment terms.</p>
            </div>
        </div>

        <div class="invoices-section">
            <h3 class="section-title">üìã Recent Invoices</h3>
            <div id="invoices-list">
                <div class="loading">Loading invoices...</div>
            </div>
        </div>

        <div class="bank-transfer-info">
            <h3 class="section-title">üè¶ Bank Transfer Information</h3>
            <p>For all payments, please use the following bank details and include the invoice number as reference.</p>

            <div class="bank-details">
                <div class="bank-detail">
                    <div class="bank-label">Bank Name</div>
                    <div class="bank-value">Enterprise Bank</div>
                </div>
                <div class="bank-detail">
                    <div class="bank-label">Account Name</div>
                    <div class="bank-value">App-Oint Enterprise</div>
                </div>
                <div class="bank-detail">
                    <div class="bank-label">IBAN</div>
                    <div class="bank-value">DE89370400440532013000</div>
                </div>
                <div class="bank-detail">
                    <div class="bank-label">SWIFT/BIC</div>
                    <div class="bank-value">COBADEFFXXX</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="firebase-client-config.js"></script>
    <script src="js/ui-helpers.js"></script>

    <script>
        // Authentication state management
        FirebaseClient.auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = '/login';
                return;
            }

            // Load user data and invoices
            loadUserData();
            loadInvoices();
        });

        async function loadUserData() {
            try {
                const userData = await FirebaseClient.api.get('/api/user');
                updateUserInfo(userData);
            } catch (error) {
                console.error('Failed to load user data:', error);
            }
        }

        function updateUserInfo(userData) {
            const userAvatar = document.querySelector('.user-avatar');
            const userName = document.querySelector('.user-info div:first-child');
            const userEmail = document.querySelector('.user-info div:last-child');

            if (userAvatar) {
                userAvatar.textContent = userData.companyName ? userData.companyName.charAt(0).toUpperCase() : 'E';
            }
            if (userName) {
                userName.textContent = userData.companyName || 'Enterprise Client';
            }
            if (userEmail) {
                userEmail.textContent = userData.email || 'billing@appoint.com';
            }
        }

        // Load invoices from API
        async function loadInvoices() {
            try {
                UIHelpers.showLoading('invoices-list', 'Loading invoices...');
                const response = await FirebaseClient.api.get('/api/invoices/user');
                displayInvoices(response.invoices);
            } catch (error) {
                console.error('Error loading invoices:', error);
                UIHelpers.showError('invoices-list', 'Failed to load invoices. Please try again later.', () => loadInvoices());
            }
        }

        function displayInvoices(invoices) {
            const container = document.getElementById('invoices-list');

            if (invoices.length === 0) {
                UIHelpers.showEmpty('invoices-list', 'No invoices found. Invoices are generated monthly.');
                return;
            }

            container.innerHTML = invoices.map(invoice => `
                <div class="invoice-item">
                    <div class="invoice-info">
                        <div class="invoice-number">${invoice.invoiceNumber}</div>
                        <div class="invoice-details">
                            ${invoice.planName} ‚Ä¢ ${UIHelpers.formatDate(invoice.invoiceDate)} ‚Ä¢ Due: ${UIHelpers.formatDate(invoice.dueDate)}
                        </div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div class="invoice-amount">${UIHelpers.formatCurrency(invoice.totalAmount)}</div>
                        <div class="invoice-status status-${invoice.status}">${invoice.status.toUpperCase()}</div>
                        <div class="invoice-actions">
                            <button onclick="downloadInvoice('${invoice.invoiceNumber}')" class="action-btn btn-primary">Download</button>
                            <button onclick="viewInvoice('${invoice.invoiceNumber}')" class="action-btn btn-secondary">View</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function downloadInvoice(invoiceNumber) {
            try {
                const response = await FirebaseClient.api.get(`/api/invoices/${invoiceNumber}`);

                // Create and download HTML invoice
                const invoiceHTML = generateInvoiceHTML(response);
                const blob = new Blob([invoiceHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `${invoiceNumber}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Error downloading invoice:', error);
                alert('Failed to download invoice. Please try again.');
            }
        }

        function viewInvoice(invoiceNumber) {
            // Open invoice in new window
            window.open(`/api/invoices/${invoiceNumber}`, '_blank');
        }

        function generateInvoiceHTML(invoiceData) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Invoice - ${invoiceData.invoiceNumber}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .invoice-details { margin-bottom: 30px; }
                        .table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        .table th, .table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                        .table th { background-color: #f8f9fa; }
                        .total { font-weight: bold; font-size: 18px; }
                        .bank-details { background-color: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 5px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>App-Oint Enterprise</h1>
                        <h2>INVOICE</h2>
                    </div>
                    
                    <div class="invoice-details">
                        <p><strong>Invoice Number:</strong> ${invoiceData.invoiceNumber}</p>
                        <p><strong>Date:</strong> ${FirebaseClient.ui.formatDate(invoiceData.invoiceDate)}</p>
                        <p><strong>Due Date:</strong> ${FirebaseClient.ui.formatDate(invoiceData.dueDate)}</p>
                        <p><strong>Client:</strong> ${invoiceData.clientName}</p>
                        <p><strong>Email:</strong> ${invoiceData.clientEmail}</p>
                    </div>
                    
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Rate</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${invoiceData.planName} Plan</td>
                                <td>1</td>
                                <td>${FirebaseClient.ui.formatCurrency(invoiceData.planPrice)}</td>
                                <td>${FirebaseClient.ui.formatCurrency(invoiceData.planPrice)}</td>
                            </tr>
                            ${invoiceData.overageCalls > 0 ? `
                            <tr>
                                <td>Overage API Calls (${invoiceData.overageCalls} calls)</td>
                                <td>${invoiceData.overageCalls}</td>
                                <td>$0.001 per call</td>
                                <td>${FirebaseClient.ui.formatCurrency(invoiceData.overageAmount)}</td>
                            </tr>
                            ` : ''}
                        </tbody>
                    </table>
                    
                    <div class="total">
                        <p><strong>Total Amount:</strong> ${FirebaseClient.ui.formatCurrency(invoiceData.totalAmount)}</p>
                    </div>
                    
                    <div class="bank-details">
                        <h3>Bank Transfer Instructions</h3>
                        <p><strong>Bank Name:</strong> Enterprise Bank</p>
                        <p><strong>Account Name:</strong> App-Oint Enterprise</p>
                        <p><strong>IBAN:</strong> DE89370400440532013000</p>
                        <p><strong>SWIFT/BIC:</strong> COBADEFFXXX</p>
                        <p><strong>Reference:</strong> ${invoiceData.invoiceNumber}</p>
                        <p><strong>Amount:</strong> ${FirebaseClient.ui.formatCurrency(invoiceData.totalAmount)}</p>
                    </div>
                </body>
                </html>
            `;
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                FirebaseClient.auth.signOut();
            }
        }
    </script>
</body>

</html>