name: üê∂ CI Watchdog

on: workflow_dispatch
permissions:
  actions: read
  contents: read

jobs:
  watchdog:
    runs-on: ubuntu-latest
    # Only run on main repository, not on forks
    if: github.repository == 'gabriellagziel/appoint'
    
    steps:
      - name: üîß Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: ü™™ Authenticate GitHub CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh auth setup-git
          gh auth status

      - name: üïµÔ∏è‚Äç‚ôÇÔ∏è Check workflow health
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Checking workflow health..."
          
          # Simple health check - just verify we can access the API
          if gh run list --limit 5 --json status,workflowName > /dev/null 2>&1; then
            echo "‚úÖ GitHub API access confirmed"
            
            # Count recent failed runs
            failed_count=$(gh run list --limit 20 --json status,workflowName,conclusion | jq -r '.[] | select(.status == "completed" and .conclusion == "failure") | .workflowName' | wc -l)
            
            if [ "$failed_count" -gt 0 ]; then
              echo "‚ö†Ô∏è Found $failed_count recent failed workflow runs"
              gh run list --limit 20 --json status,workflowName,conclusion,url | jq -r '.[] | select(.status == "completed" and .conclusion == "failure") | "‚ùå " + .workflowName + ": " + .url'
            else
              echo "‚úÖ No recent failed workflow runs found"
            fi
            
            # Check for stuck workflows (running > 30 minutes)
            stuck_count=$(gh run list --limit 50 --json status,workflowName,duration,startedAt | jq -r '.[] | select(.status == "in_progress" and (.duration | tonumber) > 1800) | .workflowName' | wc -l)
            
            if [ "$stuck_count" -gt 0 ]; then
              echo "üö® Found $stuck_count stuck workflows (running > 30 minutes)"
              gh run list --limit 50 --json status,workflowName,duration,startedAt,url | jq -r '.[] | select(.status == "in_progress" and (.duration | tonumber) > 1800) | "‚è∞ " + .workflowName + " (running " + (.duration | tonumber | . / 60 | floor | tostring) + " minutes): " + .url'
            else
              echo "‚úÖ No stuck workflows found"
            fi
            
          else
            echo "‚ùå Cannot access GitHub API - check permissions"
            exit 1
          fi
          
      - name: üßπ Cleanup
        if: always()
        run: |
          echo "üßπ Watchdog check completed"
