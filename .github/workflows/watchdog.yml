name: CI Watchdog
on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  actions: read

concurrency:
  group: watchdog-${{ github.ref }}
  cancel-in-progress: true

jobs:
  watchdog:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Quick environment sanity
        run: |
          echo "REF=${GITHUB_REF}"
          echo "SHA=${GITHUB_SHA}"
          git --version

      - name: Validate workflow YAML
        run: |
          sudo apt-get update -y
          sudo apt-get install -y yamllint
          yamllint -d "{extends: default, rules: {line-length: disable}}" .github/workflows

      - name: Large-file guard (40MB+)
        run: |
          set -e
          python3 - <<'PY'
          import os, subprocess, sys
          files = subprocess.check_output(['git','ls-files']).decode().splitlines()
          bad = []
          for f in files:
            try:
              if os.path.getsize(f) > 40*1024*1024:
                bad.append((f, os.path.getsize(f)))
            except FileNotFoundError:
              pass
          if bad:
            print("Large files detected:")
            for f,s in bad: print(f"{f} -> {s} bytes")
            sys.exit(1)
          PY
          echo "No oversized files committed."

      - name: Watchdog OK
        run: echo "âœ… CI Watchdog passed"
