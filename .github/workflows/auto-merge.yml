name: Auto Merge

on: workflow_dispatch
jobs:
  # Auto-merge PRs on green CI
  auto-merge:
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Check if PR exists
        id: check-pr
        run: |
          # Find PR associated with this workflow run
          PR_NUMBER=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/jobs --jq '.jobs[0].steps[] | select(.name == "Checkout code") | .number')
          if [ -n "$PR_NUMBER" ]; then
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          fi
          
      - name: Auto-merge PR
        if: steps.check-pr.outputs.pr_number != ''
        run: |
          PR_NUMBER=${{ steps.check-pr.outputs.pr_number }}
          
          # Check if PR is mergeable
          MERGEABLE=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER --jq '.mergeable')
          
          if [ "$MERGEABLE" = "true" ]; then
            echo "üîÑ Auto-merging PR #$PR_NUMBER..."
            gh pr merge $PR_NUMBER --auto --merge
            echo "‚úÖ PR #$PR_NUMBER merged successfully"
          else
            echo "‚ö†Ô∏è PR #$PR_NUMBER is not mergeable (conflicts or not ready)"
          fi

  # Provide bot feedback on PR
  bot-feedback:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Echo manual-only
        run: echo "Manual-only bot feedback disabled for PR events"
