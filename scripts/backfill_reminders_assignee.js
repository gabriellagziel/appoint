const admin = require("firebase-admin"); const backfillReminders = async () => { const firestore = admin.firestore(); console.log("ðŸ”„ Starting assigneeId backfill..."); try { const remindersSnapshot = await firestore.collection("reminders").where("assigneeId", "==", null).get(); console.log(`ðŸ“Š Found ${remindersSnapshot.size} reminders without assigneeId`); if (remindersSnapshot.size === 0) { console.log("âœ… No reminders need updating"); return; } const batchSize = 500; let processedCount = 0; for (let i = 0; i < remindersSnapshot.size; i += batchSize) { const batch = firestore.batch(); const batchDocs = remindersSnapshot.docs.slice(i, i + batchSize); batchDocs.forEach((doc) => { const reminder = doc.data(); batch.update(doc.ref, { assigneeId: reminder.ownerId, visibility: reminder.visibility || "private", updatedAt: admin.firestore.FieldValue.serverTimestamp(), }); }); await batch.commit(); processedCount += batchDocs.length; console.log(`âœ… Processed batch: ${batchDocs.length} reminders`); } console.log(`ðŸŽ‰ Successfully updated ${processedCount} reminders`); } catch (error) { console.error("âŒ Error during backfill:", error); throw error; } }; const validateBackfill = async () => { const firestore = admin.firestore(); console.log("ðŸ” Validating backfill results..."); try { const remainingSnapshot = await firestore.collection("reminders").where("assigneeId", "==", null).get(); if (remainingSnapshot.size === 0) { console.log("âœ… All reminders now have assigneeId"); } else { console.log(`âš ï¸ Found ${remainingSnapshot.size} reminders still without assigneeId`); } const totalSnapshot = await firestore.collection("reminders").get(); console.log(`ðŸ“Š Total reminders in database: ${totalSnapshot.size}`); } catch (error) { console.error("âŒ Error during validation:", error); throw error; } }; const main = async () => { console.log("ðŸš€ Starting assigneeId backfill process..."); try { await backfillReminders(); await validateBackfill(); console.log("ðŸŽ‰ Backfill process completed successfully!"); } catch (error) { console.error("ðŸ’¥ Backfill process failed:", error); process.exit(1); } }; if (require.main === module) { main(); }

